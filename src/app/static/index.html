<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fleet Maintenance Agent</title>
<style>
  :root { --bg:#0b1220; --card:#121a2b; --text:#e8eefc; --muted:#9bb0d1; --accent:#6aaeff; --ok:#30d158; --warn:#ffd60a; --bad:#ff453a; --border:#1e2a44; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background:var(--bg); color:var(--text);}
  header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  header h1 { margin:0; font-size:18px; font-weight:600; }
  main { display:grid; grid-template-columns: 360px 1fr; gap:20px; padding:20px; }
  @media (max-width: 920px) { main { grid-template-columns: 1fr; } }
  .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; }
  label { font-size:12px; color:var(--muted); display:block; margin:8px 0 6px; }
  input, textarea, select { width:100%; padding:10px 12px; border-radius:12px; border:1px solid #2a3b60; background:#0f1727; color:var(--text); }
  textarea { min-height:120px; font-family: ui-monospace, "SFMono-Regular", Menlo, Consolas, "Liberation Mono", monospace; }
  button { cursor:pointer; padding:12px 14px; border-radius:12px; border:1px solid #2a3b60; background:#10203a; color:var(--text); }
  button.primary { background:linear-gradient(180deg, #1a66ff, #114ee0); border:none; }
  button:disabled { opacity:0.6; cursor:not-allowed;}
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .metrics { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
  .metric { background:#0e1526; border:1px solid #1f2b49; border-radius:12px; padding:12px; }
  .metric h3 { margin:0; font-size:12px; color:var(--muted); font-weight:500; }
  .metric .val { font-size:20px; margin-top:6px; }
  .good { color: var(--ok); } .warn { color: var(--warn);} .bad { color: var(--bad); }
  pre { background:#0e1526; border:1px solid #1f2b49; border-radius:12px; padding:12px; overflow:auto; }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #2a3b60; }
  .hint { color:var(--muted); font-size:12px; margin-top:6px; }
  .footer { padding:16px 20px; color:var(--muted); font-size:12px; border-top:1px solid var(--border); }
</style>
</head>
<body>
<header>
  <h1>üõ†Ô∏è Fleet Maintenance Agent</h1>
  <span class="pill">API: <code id="api-base"></code></span>
</header>

<main>
  <section class="card">
    <h2 style="margin:4px 0 12px;">Submit Telemetry</h2>
    <div class="row">
        <div>
            <label>Region</label>
            <select id="region"></select>
        </div>
        <div>
            <label>Fleet ID</label>
            <select id="fleetid" disabled></select>
        </div>
    </div>
    <div class="row">
        <div>
            <label>Truck ID</label>
            <select id="truckid" disabled></select>
        </div>
        <div></div>
    </div>      
    <label>Optional: Telemetry JSON</label>
    <textarea id="telemetry" placeholder='{"Measurement_timestamp":"22FEB16:17:55:52","Vehicle_speed_sensor":26,...}'></textarea>
    <div class="hint">Leave empty to let the backend simulate the latest reading.</div>
    <div style="display:flex; gap:10px; margin-top:12px;">
      <button id="run" class="primary">Run Agent</button>
      <button id="clear">Clear</button>
    </div>
    <div class="hint" id="status"></div>
  </section>

  <section class="card">
    <h2 style="margin:4px 0 12px;">Result</h2>
    <div class="metrics" id="metrics">
      <div class="metric">
        <h3>Failure Prob (7d)</h3>
        <div class="val" id="m-prob">‚Äì</div>
      </div>
      <div class="metric">
        <h3>Maintenance Needed</h3>
        <div class="val" id="m-maint">‚Äì</div>
      </div>
      <div class="metric">
        <h3>Urgency</h3>
        <div class="val" id="m-urgency">‚Äì</div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label>Action</label>
      <div id="m-action">‚Äì</div>
    </div>

    <div style="margin-top:12px;">
      <label>Why (LLM)</label>
      <div id="m-expl">‚Äì</div>
    </div>

    <div style="margin-top:12px;">
      <label>Usage</label>
      <div id="usage">
        <div>Model: <code id="u-model">‚Äì</code></div>
        <div>Prompt tokens: <span id="u-pt">0</span></div>
        <div>Completion tokens: <span id="u-ct">0</span></div>
        <div>Total tokens: <b id="u-tt">0</b></div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label>Raw JSON</label>
      <pre id="raw">‚Äì</pre>
    </div>
  </section>

  <div id="popup" class="popup">
    <div class="popup-content">
      <span id="popup-close">&times;</span>
      <h2>‚ö†Ô∏è Urgent Alert</h2>
      <p id="popup-message">‚Äì</p>
    </div>
  </div>

  <style>
    /* Popup modal styles */
    .popup {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .popup-content {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      width: 360px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      text-align: center;
    }
    #popup-close {
      float: right;
      cursor: pointer;
      font-size: 20px;
      color: var(--muted);
    }
    #popup-close:hover { color: var(--text); }
  </style>

</main>

<div class="footer">
  Tip: If your API is HTTPS, host this page via HTTPS too (e.g., S3 + CloudFront) to avoid mixed-content blocks.
</div>

<script>
  // ---- Configure this to your FastAPI base URL ----
  const API_BASE = "http://3.107.198.116:8000"; // fallback for file://
  document.getElementById("api-base").textContent = API_BASE;

  const el = (id) => document.getElementById(id);
  const setStatus = (msg) => el("status").textContent = msg || "";
  const cls = (prob) => prob >= 0.6 ? "bad" : prob >= 0.3 ? "warn" : "good";

  // Populate a <select> with options
  function fillSelect(selectEl, values, placeholder) {
    selectEl.innerHTML = "";
    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholder;
    ph.disabled = true;
    ph.selected = true;
    selectEl.appendChild(ph);

    for (const v of values) {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    }
  }

  async function fetchJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function loadRegions() {
    const regionSel = el("region");
    const fleetSel = el("fleetid");
    const truckSel = el("truckid");

    try {
      const data = await fetchJSON(`${API_BASE}/meta/regions`);
      fillSelect(regionSel, data.regions || [], "Select region");
      // reset dependents
      fillSelect(fleetSel, [], "Select fleet");
      fillSelect(truckSel, [], "Select truck");
      fleetSel.disabled = true;
      truckSel.disabled = true;
    } catch (e) {
      console.error("Failed to load regions", e);
      setStatus("Failed to load regions");
    }
  }

  async function loadFleets() {
    const regionSel = el("region");
    const fleetSel = el("fleetid");
    const truckSel = el("truckid");
    const region = regionSel.value;

    if (!region) return;

    try {
      const data = await fetchJSON(`${API_BASE}/meta/fleets?region=${encodeURIComponent(region)}`);
      fillSelect(fleetSel, data.fleets || [], "Select fleet");
      fleetSel.disabled = false;
      // reset trucks
      fillSelect(truckSel, [], "Select truck");
      truckSel.disabled = true;
    } catch (e) {
      console.error("Failed to load fleets", e);
      setStatus("Failed to load fleets");
    }
  }

  async function loadTrucks() {
    const region = el("region").value;
    const fleetid = el("fleetid").value;
    const truckSel = el("truckid");

    if (!region || !fleetid) return;

    try {
      const data = await fetchJSON(`${API_BASE}/meta/trucks?region=${encodeURIComponent(region)}&fleetid=${encodeURIComponent(fleetid)}`);
      fillSelect(truckSel, data.trucks || [], "Select truck");
      truckSel.disabled = false;
    } catch (e) {
      console.error("Failed to load trucks", e);
      setStatus("Failed to load trucks");
    }
  }

  // Wire cascading changes once DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    // show base in header
    const apiBaseEl = el("api-base");
    if (apiBaseEl) apiBaseEl.textContent = API_BASE;

    // initial load
    loadRegions();

    // onchange cascade
    el("region").addEventListener("change", loadFleets);
    el("fleetid").addEventListener("change", loadTrucks);
  });


  async function runAgent() {
    setStatus("");
    const runBtn = el("run");
    runBtn.disabled = true;
    runBtn.textContent = "Running‚Ä¶";

    const regionVal = el("region").value;
    const region = Number(regionVal);
    const fleetid = el("fleetid").value;
    const truckid = el("truckid").value;

    if (!fleetid || !truckid || !regionVal || Number.isNaN(region)) {
      alert("Please fill Fleet ID, Truck ID, and Region (number).");
      runBtn.disabled = false; runBtn.textContent = "Run Agent"; return;
    }

    let new_reading = undefined;
    const t = el("telemetry").value.trim();
    if (t) {
      try { new_reading = JSON.parse(t); }
      catch (e) { alert("Invalid telemetry JSON."); runBtn.disabled = false; runBtn.textContent = "Run Agent"; return; }
    }

    try {
      const res = await fetch(`${API_BASE}/run`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ fleetid, truckid, region, new_reading })
      });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(`API error: ${msg}`);
      }
      const out = await res.json();
      render(out);
      setStatus("Success");
    } catch (err) {
      console.error(err);
      alert(err.message || "Request failed.");
      setStatus("Error");
    } finally {
      runBtn.disabled = false;
      runBtn.textContent = "Run Agent";
    }
  }

  function render(out) {
    const prob = Number(out?.prob ?? 0);
    el("m-prob").textContent = (isNaN(prob) ? "‚Äì" : prob.toFixed(4));
    el("m-prob").className = "val " + cls(prob);

    const need = !!out?.maintenance_needed;
    el("m-maint").textContent = need ? "Yes" : "No";
    el("m-maint").className = "val " + (need ? "bad" : "good");

    const urg = out?.urgency ?? "‚Äì";
    el("m-urgency").textContent = urg;

    const action = out?.action ?? "‚Äì";
    el("m-action").textContent = action;
    el("m-expl").textContent  = out?.explanation ?? "‚Äì";

    // Show popup if urgency is "high"
    if (String(urg).toLowerCase() === "high") {
      el("popup-message").textContent = action;
      el("popup").style.display = "flex";
    }

    // USAGE (expects backend to return out.usage)
    const u = out?.usage || {};
    el("u-model").textContent = u.model || "‚Äì";
    el("u-pt").textContent    = u.prompt_tokens ?? 0;
    el("u-ct").textContent    = u.completion_tokens ?? 0;
    el("u-tt").textContent    = u.total_tokens ?? 0;
    el("raw").textContent = JSON.stringify(out, null, 2);
  }

  document.getElementById("run").addEventListener("click", runAgent);
  document.getElementById("clear").addEventListener("click", () => {
    el("telemetry").value = "";
    ["m-prob","m-maint","m-urgency","m-action","m-expl","raw"].forEach(id => el(id).textContent = "‚Äì");
    // reset usage block too
    el("u-model").textContent = "‚Äì";
    el("u-pt").textContent = "0";
    el("u-ct").textContent = "0";
    el("u-tt").textContent = "0";
    el("u-cost").textContent = "$0.000000";
    setStatus("");
  });
  document.getElementById("popup-close").addEventListener("click", () => {
    el("popup").style.display = "none";
  });

</script>
</body>
</html>
